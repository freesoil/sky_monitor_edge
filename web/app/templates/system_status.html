<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Status - Edge Monitor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f6fa;
            color: #333;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .nav-links {
            margin-top: 15px;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            margin: 0 15px;
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            transition: background 0.3s ease;
        }

        .nav-links a:hover {
            background: rgba(255,255,255,0.3);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .status-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
            transition: transform 0.3s ease;
        }

        .status-card:hover {
            transform: translateY(-5px);
        }

        .status-card h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-card .icon {
            font-size: 1.8rem;
        }

        .status-value {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .status-value.success {
            color: #27ae60;
        }

        .status-value.warning {
            color: #f39c12;
        }

        .status-value.error {
            color: #e74c3c;
        }

        .status-detail {
            color: #666;
            font-size: 0.9rem;
        }

        .device-info {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .device-info h2 {
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .device-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
            display: inline-block;
            margin-left: 10px;
        }

        .device-status.online {
            background: #d4edda;
            color: #155724;
        }

        .device-status.offline {
            background: #f8d7da;
            color: #721c24;
        }

        .controls {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
            margin-bottom: 30px;
        }

        .controls h2 {
            color: #333;
            margin-bottom: 20px;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            margin: 5px;
            transition: background 0.3s ease;
        }

        .btn:hover {
            background: #5a6fd8;
        }

        .btn.warning {
            background: #f39c12;
        }

        .btn.warning:hover {
            background: #e67e22;
        }

        .log-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .log-content {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            .status-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìä System Status</h1>
        <p>Monitor your Edge Monitoring device</p>
        <div class="nav-links">
            <a href="/">üè† Home</a>
            <a href="/camera-control">üìπ Camera Control</a>
            <a href="/api-docs">üìö API Docs</a>
        </div>
    </div>

    <div class="container">
        <!-- Device Info -->
        <div class="device-info">
            <h2>üì± Edge Monitor Device</h2>
            <p>IP Address: 192.168.1.52:80 <span id="connection-status" class="device-status">Checking...</span></p>
        </div>

        <!-- System Overview -->
        <div class="status-grid">
            <div class="status-card">
                <h3><span class="icon">üì°</span>Network Status</h3>
                <div class="status-value" id="network-status">--</div>
                <div class="status-detail">WiFi connectivity and signal strength</div>
            </div>

            <div class="status-card">
                <h3><span class="icon">üíæ</span>Storage Usage</h3>
                <div class="status-value" id="storage-usage">--</div>
                <div class="status-detail">SD card space and video files</div>
            </div>

            <div class="status-card">
                <h3><span class="icon">üß†</span>Memory Usage</h3>
                <div class="status-value" id="memory-usage">--</div>
                <div class="status-detail">Heap and PSRAM utilization</div>
            </div>

            <div class="status-card">
                <h3><span class="icon">üìπ</span>Recording Status</h3>
                <div class="status-value" id="recording-status">--</div>
                <div class="status-detail">Active recording sessions</div>
            </div>

            <div class="status-card">
                <h3><span class="icon">‚è±Ô∏è</span>System Uptime</h3>
                <div class="status-value" id="uptime">--</div>
                <div class="status-detail">Device operational time</div>
            </div>

            <div class="status-card">
                <h3><span class="icon">üìÅ</span>Files</h3>
                <div class="status-value" id="file-count">--</div>
                <div class="status-detail">Total recorded video files</div>
            </div>
        </div>

        <!-- System Controls -->
        <div class="controls">
            <h2>üîß System Controls</h2>
            <button class="btn" onclick="refreshStatus()">üîÑ Refresh Status</button>
            <button class="btn warning" onclick="restartDevice()">‚ö†Ô∏è Restart Device</button>
        </div>

        <!-- SD Card File Management -->
        <div class="controls">
            <h2>üíæ SD Card File Management</h2>
            <button class="btn" onclick="listSDFiles()">üìÇ List Files</button>
            <button class="btn warning" onclick="clearSDFiles()">üóëÔ∏è Clear All Files</button>
            <div id="sd-files-list" style="margin-top: 15px;"></div>
        </div>

        <!-- System Log -->
        <div class="log-section">
            <h2>üìã System Log</h2>
            <div class="log-content" id="system-log">
                <div>Initializing system status monitoring...</div>
            </div>
        </div>
    </div>

    <script>
        let logLines = [];
        let deviceIP = null;
        let devicePort = null;

        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logLines.push(logEntry);
            
            // Keep only last 50 log entries
            if (logLines.length > 50) {
                logLines.shift();
            }
            
            const logElement = document.getElementById('system-log');
            logElement.innerHTML = logLines.map(line => `<div>${line}</div>`).join('');
            logElement.scrollTop = logElement.scrollHeight;
        }

        async function loadDeviceConfig() {
            try {
                const response = await fetch('/api/device/config');
                const result = await response.json();
                
                if (result.success && result.configured && result.device) {
                    deviceIP = result.device.ip;
                    devicePort = result.device.port || 80;
                    
                    // Update the device info display
                    const deviceInfoP = document.querySelector('.device-info p');
                    deviceInfoP.innerHTML = `IP Address: ${deviceIP}:${devicePort} <span id="connection-status" class="device-status">Checking...</span>`;
                    
                    addLog(`Using configured device: ${deviceIP}:${devicePort}`);
                    return true;
                } else {
                    addLog('No device configured. Please configure a device on the home page.');
                    const deviceInfoP = document.querySelector('.device-info p');
                    deviceInfoP.innerHTML = `<span style="color: #e74c3c;">‚ö†Ô∏è No device configured. <a href="/" style="color: #667eea;">Configure device</a></span>`;
                    return false;
                }
            } catch (error) {
                addLog(`Error loading device config: ${error.message}`);
                return false;
            }
        }

        async function refreshStatus() {
            addLog('Refreshing system status...');
            
            try {
                const response = await fetch('/api/camera/status');
                const result = await response.json();
                
                if (result.success) {
                    const status = result.status;
                    
                    // Update connection status
                    const connectionStatus = document.getElementById('connection-status');
                    connectionStatus.textContent = status.wifi_connected ? 'Online' : 'Offline';
                    connectionStatus.className = `device-status ${status.wifi_connected ? 'online' : 'offline'}`;
                    
                    // Update status cards
                    document.getElementById('network-status').textContent = status.wifi_connected ? 'Connected' : 'Disconnected';
                    document.getElementById('network-status').className = `status-value ${status.wifi_connected ? 'success' : 'error'}`;
                    
                    document.getElementById('storage-usage').textContent = `${status.storage_used || 0}MB`;
                    document.getElementById('storage-usage').className = `status-value ${(status.storage_used || 0) < 1000 ? 'success' : 'warning'}`;
                    
                    document.getElementById('memory-usage').textContent = `${Math.round((status.free_heap || 0) / 1024)}KB`;
                    document.getElementById('memory-usage').className = `status-value ${(status.free_heap || 0) > 50000 ? 'success' : 'warning'}`;
                    
                    document.getElementById('recording-status').textContent = status.is_recording ? 'Active' : 'Idle';
                    document.getElementById('recording-status').className = `status-value ${status.is_recording ? 'warning' : 'success'}`;
                    
                    document.getElementById('uptime').textContent = formatUptime(status.uptime || 0);
                    document.getElementById('uptime').className = 'status-value success';

                    document.getElementById('file-count').textContent = status.file_count || 0;
                    document.getElementById('file-count').className = 'status-value success';
                    
                    addLog('Status refresh completed successfully');
                } else {
                    addLog('Failed to refresh status: No response from device');
                }
            } catch (error) {
                addLog(`Status refresh failed: ${error.message}`);
            }
        }

        async function restartDevice() {
            if (!confirm('Are you sure you want to restart the device?')) {
                return;
            }
            
            addLog('Sending restart command to device...');
            
            try {
                const response = await fetch('/api/camera/command', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ command: 'restart' })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addLog('Restart command sent successfully');
                    addLog('Device will be offline for ~30 seconds during restart');
                    
                    // Refresh status after delay
                    setTimeout(() => {
                        addLog('Attempting to reconnect to restarted device...');
                        refreshStatus();
                    }, 30000);
                } else {
                    addLog(`Restart command failed: ${result.error || 'Unknown error'}`);
                }
            } catch (error) {
                addLog(`Restart command failed: ${error.message}`);
            }
        }

        async function listSDFiles() {
            addLog('Fetching SD card file list...');
            
            try {
                // Use server proxy API instead of direct device access (avoids CORS)
                const response = await fetch('/api/device/files');
                const data = await response.json();
                
                const filesList = document.getElementById('sd-files-list');
                const files = data.files || [];
                const totalFiles = data.total_files || 0;
                const queueSize = data.upload_queue_size || 0;
                
                addLog(`Found ${totalFiles} files on SD card (${queueSize} in upload queue)`);
                addLog(`Device: ${data.device_url || 'Unknown'}`);
                
                if (files.length === 0) {
                    filesList.innerHTML = '<div style="padding: 15px; background: #fff3cd; border-radius: 8px; margin-top: 10px;">‚ö†Ô∏è No files found on SD card</div>';
                } else {
                    let html = `<div style="background: white; padding: 15px; border-radius: 8px; margin-top: 10px; max-height: 300px; overflow-y: auto;">`;
                    html += `<h4 style="margin-bottom: 10px;">üìÅ Files (${totalFiles} total, showing ${files.length})</h4>`;
                    html += '<table style="width: 100%; border-collapse: collapse;">';
                    html += '<thead><tr style="border-bottom: 2px solid #ddd;">';
                    html += '<th style="text-align: left; padding: 8px;">File Name</th>';
                    html += '<th style="text-align: right; padding: 8px;">Size</th>';
                    html += '</tr></thead><tbody>';
                    
                    files.forEach(file => {
                        const sizeKB = (file.size / 1024).toFixed(2);
                        const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
                        const displaySize = file.size > 1024 * 1024 ? `${sizeMB} MB` : `${sizeKB} KB`;
                        
                        html += '<tr style="border-bottom: 1px solid #eee;">';
                        html += `<td style="padding: 8px; font-family: monospace;">${file.name}</td>`;
                        html += `<td style="padding: 8px; text-align: right;">${displaySize}</td>`;
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table></div>';
                    filesList.innerHTML = html;
                }
            } catch (error) {
                addLog(`Failed to list SD files: ${error.message}`);
                const filesList = document.getElementById('sd-files-list');
                filesList.innerHTML = '<div style="padding: 15px; background: #f8d7da; border-radius: 8px; margin-top: 10px;">‚ùå Failed to fetch file list. Check if device is connected.</div>';
            }
        }

        async function clearSDFiles() {
            if (!confirm('‚ö†Ô∏è WARNING: This will DELETE ALL video and photo files from the SD card!\n\nAre you sure you want to continue?')) {
                addLog('Clear SD files cancelled by user');
                return;
            }
            
            addLog('Clearing SD card files...');
            
            try {
                // Use server proxy API instead of direct device access (avoids CORS)
                const response = await fetch('/api/device/clear-files', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addLog(`‚úÖ SD card cleared: ${result.message}`);
                    addLog(`Device: ${result.device_url || 'Unknown'}`);
                    
                    // Clear the files list display
                    const filesList = document.getElementById('sd-files-list');
                    filesList.innerHTML = '<div style="padding: 15px; background: #d4edda; border-radius: 8px; margin-top: 10px;">‚úÖ All files deleted successfully</div>';
                    
                    // Refresh status to update file count
                    setTimeout(refreshStatus, 1000);
                } else {
                    addLog(`‚ùå Clear SD failed: ${result.message || 'Unknown error'}`);
                }
            } catch (error) {
                addLog(`‚ùå Clear SD failed: ${error.message}`);
            }
        }

        function formatUptime(milliseconds) {
            const seconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (days > 0) {
                return `${days}d ${hours % 24}h`;
            } else if (hours > 0) {
                return `${hours}h ${minutes % 60}m`;
            } else if (minutes > 0) {
                return `${minutes}m ${seconds % 60}s`;
            } else {
                return `${seconds}s`;
            }
        }

        // Auto-refresh every 30 seconds
        setInterval(refreshStatus, 30000);

        // Initial load
        document.addEventListener('DOMContentLoaded', async function() {
            addLog('System status page loaded');
            const hasDevice = await loadDeviceConfig();
            if (hasDevice) {
                addLog(`Connecting to device at ${deviceIP}:${devicePort}...`);
                refreshStatus();
            } else {
                addLog('Waiting for device configuration...');
            }
        });
    </script>
</body>
</html> 